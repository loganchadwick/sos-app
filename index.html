<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOS - Sense of Self</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // Initialize Supabase
    const supabaseClient = supabase.createClient(
      'https://rshjkefxnvxgvglrxphe.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzaGprZWZ4bnZ4Z3ZnbHJ4cGhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MDM2MzYsImV4cCI6MjA4MjI3OTYzNn0.Kby1kR1BzCreyjirUgBacoBAKVVz48I08nqpF8LHV60'
    );

    // Icons
    const Plus = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M5 12h14"/><path d="M12 5v14"/>
      </svg>
    );

    const X = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
      </svg>
    );

    const Copy = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
      </svg>
    );

    const Users = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
    );

    const CheckCircle = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
      </svg>
    );

    function SOSApp() {
      const [view, setView] = useState('home'); // 'home', 'create', 'reflect', 'waiting', 'results'
      const [activityName, setActivityName] = useState('');
      const [players, setPlayers] = useState(['', '']);
      const [activityId, setActivityId] = useState(null);
      const [currentPlayer, setCurrentPlayer] = useState('');
      const [activityDescription, setActivityDescription] = useState('');
      const [playerDescriptions, setPlayerDescriptions] = useState({});
      const [activityData, setActivityData] = useState(null);
      const [allReflections, setAllReflections] = useState([]);
      const [submittedCount, setSubmittedCount] = useState(0);
      const [copiedLink, setCopiedLink] = useState('');

      // Check URL for activity ID and player name
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('activity');
        const player = params.get('player');
        
        if (id) {
          setActivityId(id);
          loadActivity(id, player);
        }
      }, []);

      const loadActivity = async (id, playerName) => {
        const { data: activity, error } = await supabaseClient
          .from('activities')
          .select('*')
          .eq('id', id)
          .single();

        if (error) {
          console.error('Error loading activity:', error);
          return;
        }

        setActivityData(activity);

        if (playerName) {
          setCurrentPlayer(playerName);
          // Check if this player already submitted
          const { data: reflection } = await supabaseClient
            .from('reflections')
            .select('*')
            .eq('activity_id', id)
            .eq('player_name', playerName)
            .single();

          if (reflection) {
            // Already submitted, show waiting/results
            checkAllSubmissions(id, activity.players);
          } else {
            // Show reflection form
            setView('reflect');
          }
        } else {
          // No player specified, show results if complete
          checkAllSubmissions(id, activity.players);
        }
      };

      const checkAllSubmissions = async (id, playerList) => {
        const { data: reflections, error } = await supabaseClient
          .from('reflections')
          .select('*')
          .eq('activity_id', id);

        if (error) {
          console.error('Error loading reflections:', error);
          return;
        }

        setAllReflections(reflections);
        setSubmittedCount(reflections.length);

        if (reflections.length === playerList.length) {
          setView('results');
        } else {
          setView('waiting');
        }
      };

      // Subscribe to real-time updates
      useEffect(() => {
        if (!activityId) return;

        const channel = supabaseClient
          .channel('reflections-changes')
          .on('postgres_changes', 
            { 
              event: 'INSERT', 
              schema: 'public', 
              table: 'reflections',
              filter: `activity_id=eq.${activityId}`
            }, 
            (payload) => {
              if (activityData) {
                checkAllSubmissions(activityId, activityData.players);
              }
            }
          )
          .subscribe();

        return () => {
          supabaseClient.removeChannel(channel);
        };
      }, [activityId, activityData]);

      const addPlayer = () => {
        setPlayers([...players, '']);
      };

      const removePlayer = (index) => {
        setPlayers(players.filter((_, i) => i !== index));
      };

      const updatePlayer = (index, value) => {
        const newPlayers = [...players];
        newPlayers[index] = value;
        setPlayers(newPlayers);
      };

      const createActivity = async () => {
        const filteredPlayers = players.filter(p => p.trim());
        
        const { data, error } = await supabaseClient
          .from('activities')
          .insert([
            {
              activity_name: activityName,
              players: filteredPlayers,
              status: 'in_progress'
            }
          ])
          .select()
          .single();

        if (error) {
          console.error('Error creating activity:', error);
          alert('Error creating activity. Please try again.');
          return;
        }

        setActivityId(data.id);
        setActivityData(data);
        setView('create');
      };

      const submitReflection = async () => {
        const { error } = await supabaseClient
          .from('reflections')
          .insert([
            {
              activity_id: activityId,
              player_name: currentPlayer,
              activity_description: activityDescription,
              player_descriptions: playerDescriptions
            }
          ]);

        if (error) {
          console.error('Error submitting reflection:', error);
          alert('Error submitting. Please try again.');
          return;
        }

        // Check if all submissions are complete
        checkAllSubmissions(activityId, activityData.players);
      };

      const copyLink = (player) => {
        const link = `${window.location.origin}${window.location.pathname}?activity=${activityId}&player=${encodeURIComponent(player)}`;
        navigator.clipboard.writeText(link);
        setCopiedLink(player);
        setTimeout(() => setCopiedLink(''), 2000);
      };

      const resetApp = () => {
        setView('home');
        setActivityName('');
        setPlayers(['', '']);
        setActivityId(null);
        setCurrentPlayer('');
        setActivityDescription('');
        setPlayerDescriptions({});
        setActivityData(null);
        setAllReflections([]);
        window.history.pushState({}, '', window.location.pathname);
      };

      // HOME VIEW - Create new activity
      if (view === 'home') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
            <div className="max-w-2xl mx-auto">
              <div className="bg-white rounded-lg shadow-lg p-6 md:p-8">
                <div className="flex items-center justify-between mb-6">
                  <div>
                    <h1 className="text-3xl font-bold text-indigo-900">SOS</h1>
                    <p className="text-indigo-600">Sense of Self</p>
                  </div>
                  <div className="w-12 h-12 text-indigo-400">
                    <Users />
                  </div>
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Activity Name
                  </label>
                  <input
                    type="text"
                    value={activityName}
                    onChange={(e) => setActivityName(e.target.value)}
                    placeholder="e.g., Team brainstorm, Game night"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Players
                  </label>
                  {players.map((player, index) => (
                    <div key={index} className="flex gap-2 mb-2">
                      <input
                        type="text"
                        value={player}
                        onChange={(e) => updatePlayer(index, e.target.value)}
                        placeholder={`Player ${index + 1} name`}
                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                      />
                      {players.length > 1 && (
                        <button
                          onClick={() => removePlayer(index)}
                          className="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                        >
                          <div className="w-5 h-5"><X /></div>
                        </button>
                      )}
                    </div>
                  ))}
                  <button
                    onClick={addPlayer}
                    className="flex items-center gap-2 text-indigo-600 hover:text-indigo-700 font-medium mt-2"
                  >
                    <div className="w-4 h-4"><Plus /></div> Add Player
                  </button>
                </div>

                <button
                  onClick={createActivity}
                  disabled={!activityName || players.filter(p => p.trim()).length < 1}
                  className="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                >
                  Create Activity
                </button>
              </div>
            </div>
          </div>
        );
      }

      // CREATE VIEW - Show links for each player
      if (view === 'create') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
            <div className="max-w-2xl mx-auto">
              <div className="bg-white rounded-lg shadow-lg p-6 md:p-8">
                <h2 className="text-2xl font-bold text-gray-900 mb-2">
                  Activity Created! ðŸŽ‰
                </h2>
                <p className="text-gray-600 mb-6">
                  {activityData.activity_name}
                </p>

                <p className="text-sm text-gray-700 mb-4">
                  Share these links with each player. They'll fill out their reflections privately, and everyone will see the results once all players have submitted.
                </p>

                <div className="space-y-3 mb-6">
                  {activityData.players.map((player, index) => (
                    <div key={index} className="flex items-center gap-2 p-3 bg-gray-50 rounded-lg">
                      <div className="flex-1">
                        <p className="font-medium text-gray-900">{player}</p>
                        <p className="text-xs text-gray-500 break-all">
                          {window.location.origin}?activity={activityId}&player={encodeURIComponent(player)}
                        </p>
                      </div>
                      <button
                        onClick={() => copyLink(player)}
                        className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm flex items-center gap-2"
                      >
                        <div className="w-4 h-4"><Copy /></div>
                        {copiedLink === player ? 'Copied!' : 'Copy'}
                      </button>
                    </div>
                  ))}
                </div>

                <button
                  onClick={resetApp}
                  className="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300 transition-colors"
                >
                  Create Another Activity
                </button>
              </div>
            </div>
          </div>
        );
      }

      // REFLECT VIEW - Player fills out their reflections
      if (view === 'reflect') {
        const otherPlayers = activityData.players.filter(p => p !== currentPlayer);
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
            <div className="max-w-2xl mx-auto">
              <div className="bg-white rounded-lg shadow-lg p-6 md:p-8">
                <h2 className="text-2xl font-bold text-gray-900 mb-2">
                  {activityData.activity_name}
                </h2>
                <p className="text-indigo-600 mb-6">Hi, {currentPlayer}!</p>

                <div className="mb-6">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Describe the activity in one word/phrase:
                  </label>
                  <input
                    type="text"
                    value={activityDescription}
                    onChange={(e) => setActivityDescription(e.target.value)}
                    placeholder="e.g., Energizing, Collaborative, Fun"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>

                {otherPlayers.length > 0 && (
                  <div className="mb-6">
                    <label className="block text-sm font-medium text-gray-700 mb-3">
                      Describe each player in one word:
                    </label>
                    {otherPlayers.map((player, index) => (
                      <div key={index} className="mb-4">
                        <label className="block text-sm text-gray-600 mb-1">
                          {player}:
                        </label>
                        <input
                          type="text"
                          value={playerDescriptions[player] || ''}
                          onChange={(e) => setPlayerDescriptions({
                            ...playerDescriptions,
                            [player]: e.target.value
                          })}
                          placeholder="e.g., Creative, Supportive, Enthusiastic"
                          className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        />
                      </div>
                    ))}
                  </div>
                )}

                <button
                  onClick={submitReflection}
                  disabled={!activityDescription || (otherPlayers.length > 0 && Object.keys(playerDescriptions).length < otherPlayers.length)}
                  className="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                >
                  Submit Reflections
                </button>
              </div>
            </div>
          </div>
        );
      }

      // WAITING VIEW - Waiting for other players
      if (view === 'waiting') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
            <div className="max-w-2xl mx-auto">
              <div className="bg-white rounded-lg shadow-lg p-6 md:p-8 text-center">
                <div className="w-16 h-16 mx-auto mb-4 text-green-500">
                  <CheckCircle />
                </div>
                <h2 className="text-2xl font-bold text-gray-900 mb-2">
                  Thanks for submitting!
                </h2>
                <p className="text-gray-600 mb-6">
                  Waiting for other players to complete their reflections...
                </p>
                
                <div className="bg-indigo-50 rounded-lg p-4 mb-6">
                  <p className="text-lg font-semibold text-indigo-900">
                    {submittedCount} of {activityData.players.length} players submitted
                  </p>
                  <div className="w-full bg-gray-200 rounded-full h-2 mt-3">
                    <div 
                      className="bg-indigo-600 h-2 rounded-full transition-all duration-500"
                      style={{ width: `${(submittedCount / activityData.players.length) * 100}%` }}
                    ></div>
                  </div>
                </div>

                <p className="text-sm text-gray-500">
                  This page will automatically update when everyone has submitted.
                </p>
              </div>
            </div>
          </div>
        );
      }

      // RESULTS VIEW - Show all reflections
      if (view === 'results') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
            <div className="max-w-4xl mx-auto">
              <div className="bg-white rounded-lg shadow-lg p-6 md:p-8">
                <h2 className="text-2xl font-bold text-gray-900 mb-2">
                  {activityData.activity_name} - Wrapped! ðŸŽŠ
                </h2>
                <p className="text-gray-600 mb-6">
                  Here's what everyone thought:
                </p>

                <div className="space-y-6">
                  {activityData.players.map((player, index) => {
                    const reflection = allReflections.find(r => r.player_name === player);
                    
                    return (
                      <div key={index} className="border-2 border-indigo-200 rounded-lg p-5 bg-indigo-50">
                        <h3 className="text-xl font-bold text-indigo-900 mb-3">{player}</h3>
                        
                        <div className="mb-4">
                          <p className="text-sm font-medium text-gray-600">Activity:</p>
                          <p className="text-lg text-gray-900">"{reflection?.activity_description}"</p>
                        </div>

                        {reflection?.player_descriptions && Object.keys(reflection.player_descriptions).length > 0 && (
                          <div>
                            <p className="text-sm font-medium text-gray-600 mb-2">Their thoughts on others:</p>
                            <div className="space-y-1">
                              {Object.entries(reflection.player_descriptions).map(([otherPlayer, desc]) => (
                                <p key={otherPlayer} className="text-gray-900">
                                  <span className="font-medium">{otherPlayer}:</span> "{desc}"
                                </p>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>

                <button
                  onClick={resetApp}
                  className="w-full mt-6 bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition-colors"
                >
                  Create New Activity
                </button>
              </div>
            </div>
          </div>
        );
      }

      return null;
    }

    ReactDOM.render(<SOSApp />, document.getElementById('root'));
  </script>
</body>
</html>
